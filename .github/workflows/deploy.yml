name: Streamlit Deployment & SharePoint Test

on:
  push:
    branches: [ main ] 

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # NEW STEP: Automated SharePoint Connection Test
      # This pulls secrets directly from the GitHub Vault for verification
      - name: Verify SharePoint Connection
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        run: |
          python -c "
          import os
          from sharepoint_uploader import SharePointUploader
          try:
              uploader = SharePointUploader(
                  tenant_id=os.getenv('AZURE_TENANT_ID'),
                  client_id=os.getenv('AZURE_CLIENT_ID'),
                  client_secret=os.getenv('AZURE_CLIENT_SECRET')
              )
              print('✅ GitHub Secrets successfully pulled! Authentication verified.')
          except Exception as e:
              print(f'❌ Failed to pull or use secrets: {e}')
              exit(1)
          "

      # Verification step to ensure Streamlit starts
      - name: Run App (Verification)
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          python -m streamlit run app.py --server.headless true & 
          sleep 15 && kill $!
